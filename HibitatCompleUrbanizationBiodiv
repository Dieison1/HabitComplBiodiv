#In this document, we will analyze the interactive effect between habitat complexity (High vs. Low) and Urban intensification on the richness, density, and LCBD of fish and insects.

## Load packages
library(ggplot2)
library(gridExtra)
library(grid)
library(car)
library(MASS)
library(lme4)
library(MResModelling)
library(sjPlot)
library(StatisticalModels)
library(factoextra)
library(ggResidpanel)

## Dataset
The data to run this analysis can be downloaded at: 


# First we will create an urbanization index using PCA
## First, we will create an index of urban intensification, using PCA method:
#  For this, we will use 5 human activity variables: 
# (i)  Human population
# (ii) Anthropogenic Imperviousness Surface
# (iii) Roads density
# (iv)  High-human land-use intensity

#This index will be created for each dataset of Fish and insect

## -------------------------------------Fish dataset----------------------------------##
## Standardizing predictors using Log transforming:
DataEuaFish$CroplandIntensity<-log(DataEuaFish$CroplandIntensity+1)
DataEuaFish$RoadsDensity<-log(DataEuaFish$RoadsDensity+1)
DataEuaFish$DensidadePopulational<-log(DataEuaFish$DensidadePopulational+1)
DataEuaFish$HighIntensiveLandUse<-log(DataEuaFish$HighIntensiveLandUse+1)
DataEuaFish$AnthropogenicImperviousnessSufaces<-log(DataEuaFish$AnthropogenicImperviousnessSufaces+1)

## Merging Urban-activities variables
UrbanActivitiesVariables_Fish<-DataEuaFish   %>%
  dplyr::select(HighIntensiveLandUse, 
                AnthropogenicImperviousnessSufaces,
                RoadsDensity,
                DensidadePopulational)
UrbanActivitiesVariables_Fish
PCASUrbanActivitiesVariables_Fish<-prcomp(UrbanActivitiesVariables_Fish[c(1:4)],center = T, scale. = T, rank. = 3)
summary(PCASUrbanActivitiesVariables_Fish) # The PCA1 axis accounted for 84% of variation

## Axis correlation
PCASUrbanActivitiesVariables_Fish
# PC1 vs HighIntensiveLandUse = 0.4835947
# PC1 vs AnthropogenicImperviousnessSufaces = 0.5291921
# PC1 vs RoadsDensity  = 0.4882935
# PC1 vs DensidadePopulational  = 0.4976558

# Plotting variable in the PCA axis
PlotUrbanActivitiesVariables_Fish<-fviz_pca_biplot(PCASUrbanActivitiesVariables_Fish,
                                      # habillage=CASUrbanActivitiesVariables_Fish$HabitatComplexity,
                                       repel = TRUE,geom = "none", 
                                       col.var = "#2E9FDF", # Variables color
                                       col.ind = "#696969",
                                       pointsize = 0,
                                       alpha.ind=0.4
)+ scale_x_continuous(breaks = c(-4,-2,-0, 2,4,8), limits = c(-3,8))+
scale_y_continuous(breaks = c(-4,-2,-0, 2,4), limits = c(-3,4)) 

PlotUrbanActivitiesVariables_Fish

## Extracting PCI axis for further analysis
Axis_UrbanActivitiesVariables_Fish<-predict(PCASUrbanActivitiesVariables_Fish,UrbanActivitiesVariables_Fish)
UrbanActivityIndex_Fish<-as.data.frame(Axis_UrbanActivitiesVariables_Fish)
DataEuaFish$UrbanActivityIndex<-UrbanActivityIndex_Fish$PC1


## ----------------------------------Insect dataset----------------------------------------------##
## Standardizing predictors using Log transforming:
DataEuaInsect$CroplandIntensity<-log(DataEuaInsect$CroplandIntensity+1)
DataEuaInsect$RoadsDensity<-log(DataEuaInsect$RoadsDensity+1)
DataEuaInsect$DensidadePopulational<-log(DataEuaInsect$DensidadePopulational+1)
DataEuaInsect$HighIntensiveLandUse<-log(DataEuaInsect$HighIntensiveLandUse+1)
DataEuaInsect$AnthropogenicImperviousnessSufaces<-log(DataEuaInsect$AnthropogenicImperviousnessSufaces+1)

## Merging Urban-activities variables
UrbanActivitiesVariables_Insect<-DataEuaInsect   %>%
  dplyr::select(HighIntensiveLandUse, 
                AnthropogenicImperviousnessSufaces,
                RoadsDensity,
                DensidadePopulational)
UrbanActivitiesVariables_Insect
PCASUrbanActivitiesVariables_Insect<-prcomp(UrbanActivitiesVariables_Insect[c(1:4)],center = T, scale. = T, rank. = 3)
summary(PCASUrbanActivitiesVariables_Insect) # The PCA1 axis accounted for 84% of variation

## Axis correlation
PCASUrbanActivitiesVariables_Insect
# PC1 vs HighIntensiveLandUse = 0.4830212
# PC1 vs AnthropogenicImperviousnessSufaces = 0.5307684
# PC1 vs CroplandIntensity = 0.4879882
# PC1 vs RoadsDensity  = 0.4968330
# PC1 vs DensidadePopulational  = 0.4933770

# Plotting variable in the PCA axis
PlotUrbanActivitiesVariables_Insect<-fviz_pca_biplot(PCASUrbanActivitiesVariables_Insect,
                                                   #habillage=HumanPressure$HabitatComplexity,
                                                   repel = TRUE,geom = "none", 
                                                   col.var = "#2E9FDF", # Variables color
                                                   col.ind = "#696969",
                                                   pointsize = 0,
                                                   alpha.ind=0.4
) + scale_x_continuous(breaks = c(-4,-2,-0, 2,4,8), limits = c(-3,8))+
  scale_y_continuous(breaks = c(-4,-2,-0, 2,4), limits = c(-4,4)) 

PlotUrbanActivitiesVariables_Insect

## Extracting PCI axis for further analysis
Axis_UrbanActivitiesVariables_Insect<-predict(PCASUrbanActivitiesVariables_Insect,UrbanActivitiesVariables_Insect)
UrbanActivityIndex_Insect<-as.data.frame(Axis_UrbanActivitiesVariables_Insect)
DataEuaInsect$UrbanActivityIndex<-UrbanActivityIndex_Insect$PC1


#############################################################################################################
## Remove NAs in the specified columns
#----------------------------------------------Fish dataset--------------------------------------------------##
DataEuaFish1 <- na.omit(DataEuaFish[,c('SITE_ID', 'Ecoregions', 'YEAR', 'HabitatComplexity', "XFC_NAT",
                               'LAT_DD83', 'LON_DD83', 'FishDensity', 'Fish_RarefiedChaoRichness', 'ObservedFishRichness',
                               'LocalFishTotalLCBD', 'LocalFishReplLCBD', 'LocalFishRichLCBD',
                               'RegionalFishTotalLBCD', 'RegionalFishReplLBCD', 'RegionalFishRichLBCD',
                               'UrbanActivityIndex')])

# look at the spread of habitat Complexity/categories
print(table(DataEuaFish1$HabitatComplexity1))

# High-habitat Complexity        Low-habitat complexity
         #1772                        #1780

## Log-transforming density
DataEuaFish1$FishDensity<-log10(DataEuaFish1$FishDensity)
##*1000 transform local and regional LCBD
DataEuaFish1$LocalFishTotalLCBD<-(asin(sqrt(DataEuaFish1$LocalFishTotalLCBD)))*100
DataEuaFish1$RegionalFishTotalLBCD<-(asin(sqrt(DataEuaFish1$RegionalFishTotalLBCD)))*1000

#----------------------------------------------Fish dataset--------------------------------------------------##
DataEuaInsect1 <- na.omit(DataEuaInsect[,c('SITE_ID', 'Ecoregions',' YEAR', 'HabitatComplexity', "XFC_NAT",
                                          'InsectDensity', 'Insect_RarefiedChaoRichness', 'ObservedInsectRichness',
                                           'LocalInsectTotalLCBD', 'LocalInsectReplLCBD', 'LocalInsectRichLCBD',
                                           'RegionalInsectTotalLBCD', 'RegionalInsectReplLBCD', 'RegionalInsectRichLBCD',
                                            'UrbanActivityIndex')])

# Look at the spread of habitat complexity/categories
print(table(DataEuaInsect$HabitatComplexity1))

# High-habitat complexity     Low-habitat complexity
          #2049                          #2044  

## Log-transforming fish density metrics
DataEuaInsect1$InsectDensity<-log(DataEuaInsect1$InsectDensity+0.1)
##*1000 transform local and regional LCBD
DataEuaInsect1$LocalInsectTotalLCBD<-(asin(sqrt(DataEuaInsect1$LocalInsectTotalLCBD)))*100
DataEuaInsect1$RegionalInsectTotalLBCD<-(asin(sqrt(DataEuaInsect1$RegionalInsectTotalLBCD)))*1000




##################################################################################################################################################
### Now, we will analyze the role of habitat complexity (High vs. Low) in buffering the impacts of urban intensification on biodiversity

###--------------------------Species richness ~ Habitat complexity vs. Urban intensification----------------------------------#
## Species Richness vs Urban Intensification
# Log-transforming rarefied richness
DataEuaFish1$Fish_RarefiedChaoRichness1<-log(DataEuaFish1$Fish_RarefiedChaoRichness)
DataEuaInsect1$Insect_RarefiedChaoRichness1<-log(DataEuaInsect1$Insect_RarefiedChaoRichness)
###--------------Fish
Modela <- GLMERSelect(modelData = DataEuaFish1,
                       responseVar = "Fish_RarefiedChaoRichness1",
                       fitFamily = "gaussian",
                       fixedFactors = "HabitatComplexity",
                       fixedTerms = list(UrbanActivityIndex=1),
                       randomStruct ="(1|Ecoregions)+(1|YEAR)",
                       fixedInteractions = c("HabitatComplexity:poly(UrbanActivityIndex,2)"))

# Save model output 
summary(Modela$model)
Anova(Modela$model)
ModelaStats <- as.data.frame(Modela$stats)
ModelaStats
tab_model(Modela$model,transform = NULL)

# Check model assumptions
Supplementary.Figure<-resid_panel(Modela$model)

###--------------Insect
Modelb <- GLMERSelect(modelData = DataEuaInsect1,
                      responseVar = "Insect_RarefiedChaoRichness1",
                      fitFamily = "gaussian",
                      fixedFactors = "HabitatComplexity",
                      fixedTerms = list(UrbanActivityIndex=1),
                      randomStruct ="(1|Ecoregions)+(1|YEAR)",
                      fixedInteractions = c("HabitatComplexity:poly(UrbanActivityIndex,2)"))

# Save model output 
summary(Modelb$model)
Anova(Modelb$model)
ModelbStats <- as.data.frame(Modelb$stats)
ModelbStats
tab_model(Modelb$model,transform = NULL)
# Check model assumptions
Supplementary.Figure<-resid_panel(Modelb$model)

###------------------------------Total density ~ Habitat complexity vs. Urban intensification----------------------------------#
## Total density vs Human activity Index
###--------------Fish
Modelc <- GLMERSelect(modelData = DataEuaFish1,
                      responseVar = "FishDensity",
                      fitFamily = "gaussian",
                      fixedFactors = "HabitatComplexity",
                      fixedTerms = list(UrbanActivityIndex=1),
                      randomStruct ="(1|Ecoregions)+(1|YEAR)",
                      fixedInteractions = c("HabitatComplexity:poly(UrbanActivityIndex,2)"))

# Save model output 
summary(Modelc$model)
ModelcStats <- as.data.frame(Modelc$stats)
ModelcStats
Anova(Modelc$model)
tab_model(Modelc$model,transform = NULL)
# Check model assumptions
Supplementary.Figure<-resid_panel(Modelc$model)

###--------------Insect
Modeld <- GLMERSelect(modelData = DataEuaInsect1,
                      responseVar = "InsectDensity",
                      fitFamily = "gaussian",
                      fixedFactors = "HabitatComplexity",
                      fixedTerms = list(UrbanActivityIndex=1),
                      randomStruct ="(1|Ecoregions)+(1|YEAR)",
                      fixedInteractions = c("HabitatComplexity:poly(UrbanActivityIndex,2)"))

# Save model output 
Anova(Modeld$model)
summary(Modeld$model)
ModeldStats <- as.data.frame(Modeld$stats)
ModeldStats
tab_model(Modeld$model,transform = NULL)


# Check model assumptions
Supplementary.Figure<-resid_panel(Modeld$model)


###---------------Ecoregional Total beta-diversity LCBD ~ Habitat complexity vs. Urban intensification----------------------------------#
###--------------Fish
Modele <- GLMERSelect(modelData = DataEuaFish1,
                      responseVar = "LocalFishTotalLCBD",
                      fitFamily = "gaussian",
                      fixedFactors = "HabitatComplexity",
                      fixedTerms = list(UrbanActivityIndex=1),
                      randomStruct ="(1|Ecoregions)+(1|YEAR)",
                      fixedInteractions = c("HabitatComplexity:poly(UrbanActivityIndex,2)"))

# Save model output 
Anova(Modele$model)
summary(Modele$model)
ModeleStats <- as.data.frame(Modele$stats)
ModeleStats
tab_model(Modele$model,transform = NULL)

# Check model assumptions
Supplementary.Figure<-resid_panel(Modelg$model)


###--------------Insect
Modelf <- GLMERSelect(modelData = DataEuaInsect1,
                      responseVar = "LocalInsectTotalLCBD",
                      fitFamily = "gaussian",
                      fixedFactors = "HabitatComplexity",
                      fixedTerms = list(UrbanActivityIndex=1),
                      randomStruct ="(1|Ecoregions)+(1|YEAR)",
                      fixedInteractions = c("HabitatComplexity:poly(UrbanActivityIndex,1)"))


# Save model output 
Anova(Modelf$model)
summary(Modelf$model)
ModelfStats <- as.data.frame(Modelf$stats)
ModelfStats

## Only to plot effect
Modelfb<-glmer(LocalInsectTotalLCBD ~ UrbanActivityIndex * HabitatComplexity +
           (1|Ecoregions)+(1|YEAR),
         family = gaussian,
         data=DataEuaInsect1)
# Save model output 
tab_model(Modelfb)

# Check model assumptions
Supplementary.Figure<-resid_panel(Modelh$model)

###-------------------National total beta-diversity LCBD ~ Habitat complexity vs. Urban intensification----------------------------------#
###--------------Fish
Modelg <- GLMERSelect(modelData = DataEuaFish1,
                      responseVar = "RegionalFishTotalLBCD",
                      fitFamily = "gaussian",
                      fixedFactors = "HabitatComplexity",
                      fixedTerms = list(UrbanActivityIndex=1),
                      randomStruct ="(1|Ecoregions)+(1|YEAR)",
                      fixedInteractions = c("HabitatComplexity:poly(UrbanActivityIndex,1)"))

# Save model output 
Anova(Modelg$model)
summary(Modelg$model)
ModelgStats <- as.data.frame(Modelg$stats)
ModelgStats

## Only to plot effect
Modelgb<-glmer(RegionalFishTotalLBCD ~ UrbanActivityIndex * HabitatComplexity +
                 (1|Ecoregions)+(1|YEAR),
               family = gaussian,
               data=DataEuaFish1)
tab_model(Modelgb)

# Check model assumptions
Supplementary.Figure<-resid_panel(Modelg$model)

###--------------Insect
Modelh <- GLMERSelect(modelData = DataEuaInsect1,
                      responseVar = "RegionalInsectTotalLBCD",
                      fitFamily = "gaussian",
                      fixedFactors = "HabitatComplexit1",
                      fixedTerms = list(UrbanActivityIndex=1),
                      randomStruct ="(1|Ecoregions)+(1|YEAR)",
                      fixedInteractions = c("HabitatComplexity:poly(UrbanActivityIndex,1)"))

# Save model output 
Anova(Modelh$model)
summary(Modelh$model)
ModelhStats <- as.data.frame(Modelh$stats)
ModelhStats

## Only to plot effect
Modelhb<-glmer(RegionalInsectTotalLBCD ~ UrbanActivityIndex * HabitatComplexity +
                 (1|Ecoregions)+(1|YEAR),
               family = gaussian,
               data=DataEuaInsect1)

# Save model output 
tab_model(Modelhb)

# Check model assumptions
Supplementary.Figure<-resid_panel(Modelh$model)


# Create dataframe for values to predict response to richness, density, and LCBD of fish and insect 
## ModelA - Fish richness ~ Habitat complexity vs. Urban intensification
nda <- expand.grid(
  UrbanActivityIndex=seq(from = min(Modela$data$UrbanActivityIndex),to = max(Modela$data$UrbanActivityIndex),
                            length.out = 100),
  HabitatComplexity=factor(c("High","Low"),levels = levels(Modela$data$HabitatComplexity)))
nda

## ModelB - Insects richness ~ Habitat complexity vs. Urban intensification
ndb <- expand.grid(
  UrbanActivityIndex=seq(from = min(Modelb$data$UrbanActivityIndex),to = max(Modelb$data$UrbanActivityIndex),
                    length.out = 100),
  HabitatComplexity=factor(c("High","Low"),levels = levels(Modelb$data$HabitatComplexity)))
ndb

## ModelC - Fish Density ~ Habitat complexity vs. Urban intensification
ndc <- expand.grid(
  UrbanActivityIndex=seq(from = min(Modelc$data$UrbanActivityIndex),to = max(Modelc$data$UrbanActivityIndex),
                                         length.out = 100),
  HabitatComplexity=factor(c("High","Low"),levels = levels(Modelc$data$HabitatComplexity)))
ndc

## ModelD - Insects density ~ Habitat complexity vs. Urban intensification
ndd <- expand.grid(
  UrbanActivityIndex=seq(from = min(Modeld$data$UrbanActivityIndex),to = max(Modele$data$UrbanActivityIndex),
                           length.out = 100),
  HabitatComplexity=factor(c("High","Low"),levels = levels(Modeld$data$HabitatComplexity)))
ndd

## ModelE - Fish Ecoregional LCBD ~ Habitat complexity vs. Urban intensification
nde <- expand.grid(
  UrbanActivityIndex=seq(from = min(Modele$data$UrbanActivityIndex),to = max(Modele$data$UrbanActivityIndex),
                         length.out = 100),
  HabitatComplexity=factor(c("High","Low"),levels = levels(Modele$data$HabitatComplexity)))
nde

## ModelF - Insects Ecoregional LCBD ~ Habitat complexity vs. Urban intensification
ndf <- expand.grid(
  UrbanActivityIndex=seq(from = min(Modelf$data$UrbanActivityIndex),to = max(Modelf$data$UrbanActivityIndex),
                         length.out = 100),
  HabitatComplexity=factor(c("High","Low"),levels = levels(Modelf$data$HabitatComplexity)))
ndf

## ModelG - Fish National LCBD ~ Habitat complexity vs. Urban intensification
ndg <- expand.grid(
  UrbanActivityIndex=seq(from = min(Modelg$data$UrbanActivityIndex),to = max(Modelg$data$UrbanActivityIndex),
                         length.out = 100),
  HabitatComplexity=factor(c("High","Low"),levels = levels(Modelg$data$HabitatComplexity)))
ndg

## ModelH - Insects National LCBD ~ Habitat complexity vs. Urban intensification
ndh <- expand.grid(
  UrbanActivityIndex=seq(from = min(Modelh$data$UrbanActivityIndex),to = max(Modelh$data$UrbanActivityIndex),
                         length.out = 100),
  HabitatComplexity=factor(c("High","Low"),levels = levels(Modelh$data$HabitatComplexity)))
ndh


### Defining diversity
nda$Fish_RarefiedChaoRichness1 <- 0
ndb$Insect_RarefiedChaoRichness1 <- 0
ndc$FishDensity <- 0
ndd$InsectDensity <- 0
nde$LocalFishTotalLCBD <- 0
ndf$LocalInsectTotalLCBD <- 0
ndg$RegionalFishTotalLBCD <- 0
ndh$RegionalInsectTotalLBCD <- 0

## Creating the predictions for ModelA - Fish richness ~ Habitat complexity vs. Urban intensification
# adjust plot 1: mean anomaly and abundance
exclQuantiles <- c(0.025,0.975)
QPVModela <- quantile(x = Modela$data$UrbanActivityIndex[
  Modela$data$HabitatComplexity=="High"],
  probs = exclQuantiles)
QALModela <- quantile(x = Modela$data$UrbanActivityIndex[
  Modela$data$HabitatComplexity=="Low"],
  probs = exclQuantiles)

# predict the results
a.preds.tmeanModela <- PredictGLMERRandIter(model = Modela$model,data = nda)

# back transform values
a.preds.tmeanModela <- exp(a.preds.tmeanModela)
a.preds.tmeanModela
# convert to relative to reference
a.preds.tmeanModela <- sweep(x = a.preds.tmeanModela,MARGIN = 2,STATS = a.preds.tmeanModela[1,],FUN = '/')

# remove anything above and below the quantiles
a.preds.tmeanModela[which((nda$HabitatComplexity=="High") & (nda$UrbanActivityIndex < QPVModela[1])),] <- NA
a.preds.tmeanModela[which((nda$HabitatComplexity=="High") & (nda$UrbanActivityIndex > QPVModela[2])),] <- NA
a.preds.tmeanModela[which((nda$HabitatComplexity=="Low") & (nda$UrbanActivityIndex < QALModela[1])),] <- NA
a.preds.tmeanModela[which((nda$HabitatComplexity=="Low") & (nda$UrbanActivityIndex > QALModela[2])),] <- NA

# Get the median, upper and lower quants for the plot
nda$PredMedian <- ((apply(X = a.preds.tmeanModela, MARGIN = 1, FUN = median,na.rm=TRUE))*100)-100
nda$PredUpper <- ((apply(X = a.preds.tmeanModela,MARGIN = 1,FUN = quantile,probs = 0.975,na.rm=TRUE))*100)-100
nda$PredLower <- ((apply(X = a.preds.tmeanModela,MARGIN = 1,FUN = quantile,probs = 0.025,na.rm=TRUE))*100)-100


## Creating the predictions for ModelB - Insects richness ~ Habitat complexity vs. Urban intensification

# adjust plot 1
exclQuantiles <- c(0.025,0.975)
QPVModelb <- quantile(x = Modelb$data$UrbanActivityIndex[
  Modelb$data$HabitatComplexity=="High"],
  probs = exclQuantiles)
QALModelb <- quantile(x = Modelb$data$UrbanActivityIndex[
  Modelb$data$HabitatComplexity=="Low"],
  probs = exclQuantiles)

# predict the results
a.preds.tmeanModelb <- PredictGLMERRandIter(model = Modelb$model,data = ndb)

# back transform values
a.preds.tmeanModelb <- exp(a.preds.tmeanModelb)
a.preds.tmeanModelb
# convert to relative to reference
a.preds.tmeanModelb <- sweep(x = a.preds.tmeanModelb,MARGIN = 2,STATS = a.preds.tmeanModelb[1,],FUN = '/')

# remove anything above and below the quantiles
a.preds.tmeanModelb[which((ndb$HabitatComplexity=="High") & (ndb$UrbanActivityIndex < QPVModelb[1])),] <- NA
a.preds.tmeanModelb[which((ndb$HabitatComplexity=="High") & (ndb$UrbanActivityIndex > QPVModelb[2])),] <- NA
a.preds.tmeanModelb[which((ndb$HabitatComplexity=="Low") & (ndb$UrbanActivityIndex < QALModelb[1])),] <- NA
a.preds.tmeanModelb[which((ndb$HabitatComplexity=="Low") & (ndb$UrbanActivityIndex > QALModelb[2])),] <- NA

# Get the median, upper, and lower quants for the plot
ndb$PredMedian <- ((apply(X = a.preds.tmeanModelb, MARGIN = 1, FUN = median,na.rm=TRUE))*100)-100
ndb$PredUpper <- ((apply(X = a.preds.tmeanModelb,MARGIN = 1,FUN = quantile,probs = 0.975,na.rm=TRUE))*100)-100
ndb$PredLower <- ((apply(X = a.preds.tmeanModelb,MARGIN = 1,FUN = quantile,probs = 0.025,na.rm=TRUE))*100)-100

## Creating the predictions for ModelC - Fish density ~ Habitat complexity vs. Urban intensification
# adjust plot 1:
exclQuantiles <- c(0.025,0.975)
QPVModelc <- quantile(x = Modelc$data$UrbanActivityIndex[
  Modelc$data$HabitatComplexity=="High"],probs = exclQuantiles)
QALModelc <- quantile(x = Modelc$data$UrbanActivityIndex[
  Modelc$data$HabitatComplexity=="Low"],probs = exclQuantiles)

# predict the results
a.preds.tmeanModelc <- PredictGLMERRandIter(model = Modelc$model,data = ndc)

# back transform values
a.preds.tmeanModelc <- exp(a.preds.tmeanModelc)
a.preds.tmeanModelc
# convert to relative to reference
a.preds.tmeanModelc<- sweep(x = a.preds.tmeanModelc,MARGIN = 2,STATS = a.preds.tmeanModelc[1,],FUN = '/')

# remove anything above and below the quantiles
a.preds.tmeanModelc[which((ndc$HabitatComplexity=="High") & (ndc$UrbanActivityIndex < QPVModelc[1])),] <- NA
a.preds.tmeanModelc[which((ndc$HabitatComplexity=="High") & (ndc$UrbanActivityIndex > QPVModelc[2])),] <- NA
a.preds.tmeanModelc[which((ndc$HabitatComplexity=="Low") & (ndc$UrbanActivityIndex < QALModelc[1])),] <- NA
a.preds.tmeanModelc[which((ndc$HabitatComplexity=="Low") & (ndc$UrbanActivityIndex > QALModelc[2])),] <- NA

# Get the median, upper, and lower quants for the plot
ndc$PredMedian <- ((apply(X = a.preds.tmeanModelc, MARGIN = 1, FUN = median,na.rm=TRUE))*100)-100
ndc$PredUpper <- ((apply(X = a.preds.tmeanModelc,MARGIN = 1,FUN = quantile,probs = 0.975,na.rm=TRUE))*100)-100
ndc$PredLower <- ((apply(X = a.preds.tmeanModelc,MARGIN = 1,FUN = quantile,probs = 0.025,na.rm=TRUE))*100)-100


## Creating the predictions for ModelD - Insect density ~ Habitat complexity vs. Urban intensification
# adjust plot 1: mean anomaly and abundance
exclQuantiles <- c(0.025,0.975)
QPVModeld <- quantile(x = Modeld$data$UrbanActivityIndex[
  Modeld$data$HabitatComplexity=="High"], probs = exclQuantiles)
QALModeld <- quantile(x = Modeld$data$UrbanActivityIndex[
  Modeld$data$HabitatComplexity=="Low"], probs = exclQuantiles)

# predict the results
a.preds.tmeanModeld <- PredictGLMERRandIter(model = Modeld$model,data = ndd)

# back transform values
a.preds.tmeanModeld <- exp(a.preds.tmeanModeld)
a.preds.tmeanModeld
# convert to relative to reference
a.preds.tmeanModeld<- sweep(x = a.preds.tmeanModeld,MARGIN = 2,STATS = a.preds.tmeanModeld[1,],FUN = '/')

# remove anything above and below the quantiles
a.preds.tmeanModeld[which((ndd$HabitatComplexity=="High") & (ndd$UrbanActivityIndex < QPVModeld[1])),] <- NA
a.preds.tmeanModeld[which((ndd$HabitatComplexity=="High") & (ndd$UrbanActivityIndex > QPVModeld[2])),] <- NA
a.preds.tmeanModeld[which((ndd$HabitatComplexity=="Low") & (ndd$UrbanActivityIndex < QALModeld[1])),] <- NA
a.preds.tmeanModeld[which((ndd$HabitatComplexity=="Low") & (ndd$UrbanActivityIndex > QALModeld[2])),] <- NA

# Get the median, upper, and lower quants for the plot
ndd$PredMedian <- ((apply(X = a.preds.tmeanModeld, MARGIN = 1, FUN = median,na.rm=TRUE))*100)-100
ndd$PredUpper <- ((apply(X = a.preds.tmeanModeld,MARGIN = 1,FUN = quantile,probs = 0.975,na.rm=TRUE))*100)-100
ndd$PredLower <- ((apply(X = a.preds.tmeanModeld,MARGIN = 1,FUN = quantile,probs = 0.025,na.rm=TRUE))*100)-100

## Creating the predictions for ModelE - Fish Ecoregional LCBD ~ Habitat complexity vs. Urban intensification
# adjust plot 1: mean anomaly and abundance
exclQuantiles <- c(0.025,0.975)
QPVModele <- quantile(x = Modele$data$UrbanActivityIndex[
  Modele$data$HabitatComplexity=="High"], probs = exclQuantiles)
QALModele <- quantile(x = Modele$data$UrbanActivityIndex[
  Modele$data$HabitatComplexity=="Low"], probs = exclQuantiles)

# predict the results
a.preds.tmeanModele <- PredictGLMERRandIter(model = Modele$model,data = nde)

# back transform values
a.preds.tmeanModele <- exp(a.preds.tmeanModele)
a.preds.tmeanModele
# convert to relative to reference
a.preds.tmeanModele<- sweep(x = a.preds.tmeanModele,MARGIN = 2,STATS = a.preds.tmeanModele[1,],FUN = '/')

# remove anything above and below the quantiles
a.preds.tmeanModele[which((nde$HabitatComplexity=="High") & (nde$UrbanActivityIndex < QPVModele[1])),] <- NA
a.preds.tmeanModele[which((nde$HabitatComplexity=="High") & (nde$UrbanActivityIndex > QPVModele[2])),] <- NA
a.preds.tmeanModele[which((nde$HabitatComplexity=="Low") & (nde$UrbanActivityIndex < QALModele[1])),] <- NA
a.preds.tmeanModele[which((nde$HabitatComplexity=="Low") & (nde$UrbanActivityIndex > QALModele[2])),] <- NA

# Get the median, upper, and lower quants for the plot
nde$PredMedian <- ((apply(X = a.preds.tmeanModele, MARGIN = 1, FUN = median,na.rm=TRUE))*100)-100
nde$PredUpper <- ((apply(X = a.preds.tmeanModele,MARGIN = 1,FUN = quantile,probs = 0.975,na.rm=TRUE))*100)-100
nde$PredLower <- ((apply(X = a.preds.tmeanModele,MARGIN = 1,FUN = quantile,probs = 0.025,na.rm=TRUE))*100)-100


## Creating the predictions for ModelF - Insect Ecoregional LCBD ~ Habitat complexity vs. Urban intensification
# adjust plot 1: mean anomaly and abundance
exclQuantiles <- c(0.025,0.975)
QPVModelf <- quantile(x = Modelf$data$UrbanActivityIndex[
  Modelf$data$HabitatComplexity=="High"], probs = exclQuantiles)
QALModelf <- quantile(x = Modelf$data$UrbanActivityIndex[
  Modelf$data$HabitatComplexity=="Low"], probs = exclQuantiles)

# predict the results
a.preds.tmeanModelf <- PredictGLMERRandIter(model = Modelf$model,data = ndf)

# back transform values
a.preds.tmeanModelf <- exp(a.preds.tmeanModelf)
a.preds.tmeanModelf
# convert to relative to reference
a.preds.tmeanModelf<- sweep(x = a.preds.tmeanModelf,MARGIN = 2,STATS = a.preds.tmeanModelf[18,],FUN = '/')

# remove anything above and below the quantiles
a.preds.tmeanModelf[which((ndf$HabitatComplexity=="Good") & (ndf$UrbanActivityIndex < QPVModelf[1])),] <- NA
a.preds.tmeanModelf[which((ndf$HabitatComplexity=="Good") & (ndf$UrbanActivityIndex > QPVModelf[2])),] <- NA
a.preds.tmeanModelf[which((ndf$HabitatComplexity=="Poor") & (ndf$UrbanActivityIndex < QALModelf[1])),] <- NA
a.preds.tmeanModelf[which((ndf$HabitatComplexity=="Poor") & (ndf$UrbanActivityIndex > QALModelf[2])),] <- NA

# Get the median, upper, and lower quants for the plot
ndf$PredMedian <- ((apply(X = a.preds.tmeanModelf, MARGIN = 1, FUN = median,na.rm=TRUE))*100)-100
ndf$PredUpper <- ((apply(X = a.preds.tmeanModelf,MARGIN = 1,FUN = quantile,probs = 0.975,na.rm=TRUE))*100)-100
ndf$PredLower <- ((apply(X = a.preds.tmeanModelf,MARGIN = 1,FUN = quantile,probs = 0.025,na.rm=TRUE))*100)-100


## Creating the predictions for ModelG - Fish National LCBD ~ Habitat complexity vs. Urban intensification
# adjust plot 1: mean anomaly and abundance
exclQuantiles <- c(0.025,0.975)
QPVModelg <- quantile(x = Modelg$data$UrbanActivityIndex[
  Modele$data$HabitatComplexity=="High"], probs = exclQuantiles)
QALModelg <- quantile(x = Modelg$data$UrbanActivityIndex[
  Modele$data$HabitatComplexity=="Low"], probs = exclQuantiles)

# predict the results
a.preds.tmeanModelg <- PredictGLMERRandIter(model = Modelg$model,data = ndg)

# back transform values
a.preds.tmeanModelg <- exp(a.preds.tmeanModelg)
a.preds.tmeanModelg
# convert to relative to reference
a.preds.tmeanModelg<- sweep(x = a.preds.tmeanModelg,MARGIN = 2,STATS = a.preds.tmeanModelg[1,],FUN = '/')

# remove anything above and below the quantiles
a.preds.tmeanModelg[which((ndg$HabitatComplexity=="High") & (ndg$UrbanActivityIndex < QPVModelg[1])),] <- NA
a.preds.tmeanModelg[which((ndg$HabitatComplexity=="High") & (ndg$UrbanActivityIndex > QPVModelg[2])),] <- NA
a.preds.tmeanModelg[which((ndg$HabitatComplexity=="Low") & (ndg$UrbanActivityIndex < QALModelg[1])),] <- NA
a.preds.tmeanModelg[which((ndg$HabitatComplexity=="Low") & (ndg$UrbanActivityIndex > QALModelg[2])),] <- NA

# Get the median, upper, and lower quants for the plot
ndg$PredMedian <- ((apply(X = a.preds.tmeanModelg, MARGIN = 1, FUN = median,na.rm=TRUE))*100)-100
ndg$PredUpper <- ((apply(X = a.preds.tmeanModelg,MARGIN = 1,FUN = quantile,probs = 0.975,na.rm=TRUE))*100)-100
ndg$PredLower <- ((apply(X = a.preds.tmeanModelg,MARGIN = 1,FUN = quantile,probs = 0.025,na.rm=TRUE))*100)-100


## Creating the predictions for ModelH - Insect National LCBD ~ Habitat complexity vs. Urban intensification
# adjust plot 1: mean anomaly and abundance
exclQuantiles <- c(0.025,0.975)
QPVModelh <- quantile(x = Modelh$data$UrbanActivityIndex[
  Modelf$data$HabitatComplexity=="High"], probs = exclQuantiles)
QALModelh <- quantile(x = Modelh$data$UrbanActivityIndex[
  Modelf$data$HabitatComplexity=="Low"], probs = exclQuantiles)

# predict the results
a.preds.tmeanModelh <- PredictGLMERRandIter(model = Modelh$model,data = ndh)

# back transform values
a.preds.tmeanModelh <- exp(a.preds.tmeanModelh)
a.preds.tmeanModelh
# convert to relative to reference
a.preds.tmeanModelh<- sweep(x = a.preds.tmeanModelh,MARGIN = 2,STATS = a.preds.tmeanModelh[1,],FUN = '/')

# remove anything above and below the quantiles
a.preds.tmeanModelh[which((ndh$HabitatComplexity=="High") & (ndh$UrbanActivityIndex < QPVModelh[1])),] <- NA
a.preds.tmeanModelh[which((ndh$HabitatComplexity=="High") & (ndh$UrbanActivityIndex > QPVModelh[2])),] <- NA
a.preds.tmeanModelh[which((ndh$HabitatComplexity=="Low") & (ndh$UrbanActivityIndex < QALModelh[1])),] <- NA
a.preds.tmeanModelh[which((ndh$HabitatComplexity=="Low") & (ndh$UrbanActivityIndex > QALModelh[2])),] <- NA

# Get the median, upper, and lower quants for the plot
ndh$PredMedian <- ((apply(X = a.preds.tmeanModelh, MARGIN = 1, FUN = median,na.rm=TRUE))*100)-100
ndh$PredUpper <- ((apply(X = a.preds.tmeanModelh,MARGIN = 1,FUN = quantile,probs = 0.975,na.rm=TRUE))*100)-100
ndh$PredLower <- ((apply(X = a.preds.tmeanModelh,MARGIN = 1,FUN = quantile,probs = 0.025,na.rm=TRUE))*100)-100

# set factor levels
nda$HabitatComplexity <- factor(nda$HabitatComplexity, levels = c("High","Low"))
ndb$HabitatComplexity <- factor(ndb$HabitatComplexity, levels = c("High","Low"))
ndc$HabitatComplexity <- factor(ndc$HabitatComplexity, levels = c("High","Low"))
ndd$HabitatComplexity <- factor(ndd$HabitatComplexity, levels = c("High","Low"))
nde$HabitatComplexity <- factor(nde$HabitatComplexity, levels = c("High","Low"))
ndf$HabitatComplexity <- factor(ndf$HabitatComplexity, levels = c("High","Low"))
ndg$HabitatComplexity <- factor(ndg$HabitatComplexity, levels = c("High","Low"))
ndh$HabitatComplexity <- factor(ndh$HabitatComplexity, levels = c("High","Low"))



##%######################################################%##
#                                                          #
####        Plot richness, density, and LCBD              ####
#  Figure 2 in the main manuscript (A-H)                   #
##%######################################################%##

# ---------------------------Fish richness vs. Urban Intensification
Figa <- ggplot(data = nda, aes(x = UrbanActivityIndex, y = PredMedian)) + 
  geom_line(aes(col = HabitatComplexity), size = 0.75) +
  geom_ribbon(aes(ymin = nda$PredLower, ymax = nda$PredUpper, 
                  fill = HabitatComplexity), alpha = 0.1) +
  geom_hline(yintercept = 0, lty = "dashed", size = 0.2) +
  scale_fill_manual(values = c("#0072B2","#D55E00")) +
  scale_colour_manual(values = c("#0072B2","#D55E00")) +
  theme_bw() + 
  scale_x_continuous(breaks = c(-2,0,2, 4, 6), limits = c(-2, 6)) +
  scale_y_continuous(breaks = c(-100,-50, 0, 50, 100), limits = c(-100, 100)) +
  ylab("Change in taxa richness (%)") +
  xlab("Urban intensification (PC1)") +
  #xlim(c(-1, 5)) +
  #ylim(c(-60,60)) +  
  theme_light(base_size = 18)+
  theme(legend.position = "none",
        title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size =16),
        #axis.text.x = element_text(size = 12, angle = 45, vjust = 0.5),
        axis.text = element_text(size =18, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        #   axis.ticks = element_line(size = 0.4), 
        axis.line = element_line(size = 0.4)) +
  theme(axis.ticks.length=unit(0.14,"inch"))+
  ggtitle("A")
Figa

# -----------------------Insect richness vs. Urban Intensification
Figb <- ggplot(data = ndb, aes(x = UrbanActivityIndex, y = PredMedian)) + 
  geom_line(aes(col = HabitatComplexity), size = 1) +
  geom_ribbon(aes(ymin = ndb$PredLower, ymax = ndb$PredUpper, 
                  fill = HabitatComplexity), alpha = 0.1) +
  geom_hline(yintercept = 0, lty = "dashed", size = 0.4) +
  scale_fill_manual(values = c("#0072B2","#D55E00")) +
  scale_colour_manual(values = c("#0072B2","#D55E00")) +
  theme_bw() + 
  scale_x_continuous(breaks = c(-2,0,2, 4, 6), limits = c(-2, 6)) +
  scale_y_continuous(breaks = c(-100,-50, 0, 50, 100), limits = c(-100, 100)) +
  ylab("Change in taxa richness (%)") +
  xlab("Urban intensification (PC1)") +
  #xlim(c(-1, 5)) +
  #ylim(c(-60,60)) +  
  theme_light(base_size = 18)+
  theme(legend.position = "none",
        title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size =16),
        #axis.text.x = element_text(size = 12, angle = 45, vjust = 0.5),
        axis.text = element_text(size =18, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        #   axis.ticks = element_line(size = 0.4), 
        axis.line = element_line(size = 0.4)) +
  theme(axis.ticks.length=unit(0.14,"inch"))+
  ggtitle("B")
Figb


# ---------------------------Fish Density vs. Urban Intensification
Figc <- ggplot(data = ndc,  aes(x = UrbanActivityIndex, y = PredMedian)) + 
  geom_line(aes(col = HabitatComplexity), size = 0.75) +
  geom_ribbon(aes(ymin = ndc$PredLower, ymax = ndc$PredUpper, 
                  fill = HabitatComplexity), alpha = 0.1) +
  geom_hline(yintercept = 0, lty = "dashed", size = 0.4) +
  scale_fill_manual(values = c("#0072B2","#D55E00")) +
  scale_colour_manual(values = c("#0072B2","#D55E00")) +
  theme_bw() + 
  scale_x_continuous(breaks = c(-2,0,2, 4, 6), limits = c(-2, 6)) +
  scale_y_continuous(breaks = c(-100,-50, 0, 50, 100), limits = c(-100, 100)) +
  ylab("Change in total density  (%)") +
  xlab("Urban intensification (PC1)") +
  #xlim(c(-1, 5)) +
  #ylim(c(-100,80)) +  
  theme_light(base_size = 18)+
  theme(legend.position = "none",
        title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size =16),
        #axis.text.x = element_text(size = 12, angle = 45, vjust = 0.5),
        axis.text = element_text(size =18, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        #   axis.ticks = element_line(size = 0.4), 
        axis.line = element_line(size = 0.4)) +
  theme(axis.ticks.length=unit(0.14,"inch"))+
  ggtitle("C")
Figc

# ------------------------Insects density vs. Urban Intensification
Figd <- ggplot(data = ndd, aes(x = UrbanActivityIndex, y = PredMedian)) + 
  geom_line(aes(col = HabitatComplexity), size = 0.75) +
  geom_ribbon(aes(ymin = ndd$PredLower, ymax = ndd$PredUpper, 
                  fill = HabitatComplexity), alpha = 0.1) +
  geom_hline(yintercept = 0, lty = "dashed", size = 0.4) +
  scale_fill_manual(values = c("#0072B2","#D55E00")) +
  scale_colour_manual(values = c("#0072B2","#D55E00")) +
  theme_bw() + 
  scale_x_continuous(breaks = c(-2,0,2, 4, 6), limits = c(-2, 6)) +
  scale_y_continuous(breaks = c(-100,-50, 0, 50, 100), limits = c(-100, 100)) +
  ylab("Change in total density  (%)") +
  xlab("Urban intensification (PC1)") +
  #xlim(c(-1, 5)) +
 # ylim(c(-60,60)) +  
  theme_light(base_size = 18)+
  theme(legend.position = "none",
        title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size =16),
        #axis.text.x = element_text(size = 12, angle = 45, vjust = 0.5),
        axis.text = element_text(size =18, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        #   axis.ticks = element_line(size = 0.4), 
        axis.line = element_line(size = 0.4)) +
  theme(axis.ticks.length=unit(0.14,"inch"))+
  ggtitle("D")
Figd

# ----------------------Fish Ecoregional LCBD vs. Urban Intensification
Fige <- ggplot(data = nde, aes(x = UrbanActivityIndex, y = PredMedian)) + 
  geom_line(aes(col = HabitatComplexity), size = 1) +
  geom_ribbon(aes(ymin = nde$PredLower, ymax = nde$PredUpper, 
                  fill = HabitatComplexity), alpha = 0.1) +
  geom_hline(yintercept = 0, lty = "dashed", size = 0.4) +
  scale_fill_manual(values = c("#0072B2","#D55E00")) +
  scale_colour_manual(values = c("#0072B2","#D55E00")) +
  theme_bw() + 
  scale_x_continuous(breaks = c(-2,0,2, 4, 6), limits = c(-2, 6)) +
 scale_y_continuous(breaks = c(-100,-50, 0, 50, 100), limits = c(-100, 100)) +
  ylab("Change in ecoregional LCBD (%)") +
  xlab("Urban intensification (PC1)") +
  #xlim(c(-1, 5)) +
 # ylim(c(-60,60)) +  
  theme_light(base_size = 18)+
  theme(legend.position = "none",
        title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size =16),
        #axis.text.x = element_text(size = 12, angle = 45, vjust = 0.5),
        axis.text = element_text(size =18, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        #   axis.ticks = element_line(size = 0.4), 
        axis.line = element_line(size = 0.4)) +
  theme(axis.ticks.length=unit(0.14,"inch"))+
  ggtitle("E")
Fige

# ----------------------------Insect Ecoregional LCBD vs. Urban Intensification
Figf <- ggplot(data = ndf, aes(x = UrbanActivityIndex, y = PredMedian)) + 
  geom_line(aes(col = HabitatComplexity), size = 1) +
  geom_ribbon(aes(ymin = ndf$PredLower, ymax = ndf$PredUpper, 
                  fill = HabitatComplexity), alpha = 0.1) +
  geom_hline(yintercept = 0, lty = "dashed", size = 0.4) +
  scale_fill_manual(values = c("#0072B2","#D55E00")) +
  scale_colour_manual(values = c("#0072B2","#D55E00")) +
  theme_bw() + 
  scale_x_continuous(breaks = c(-2,0,2, 4, 6), limits = c(-2, 6)) +
  scale_y_continuous(breaks = c(-100,-50, 0, 50, 100), limits = c(-100, 100)) +
  ylab("Change in ecoregional LCBD (%)") +
  xlab("Urban intensification (PC1)") +
  #xlim(c(-1, 5)) +
#  ylim(c(-60,60)) +  
  theme_light(base_size = 18)+
  theme(legend.position = "none",
        title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size =16),
        #axis.text.x = element_text(size = 12, angle = 45, vjust = 0.5),
        axis.text = element_text(size =18, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        #   axis.ticks = element_line(size = 0.4), 
        axis.line = element_line(size = 0.4)) +
  theme(axis.ticks.length=unit(0.14,"inch"))+
  ggtitle("F")
Figf


# -----------------------Fish National LCBD vs. Urban Intensification
Figg <- ggplot(data = ndg, aes(x = UrbanActivityIndex, y = PredMedian)) + 
  geom_line(aes(col = HabitatComplexity), size = 1) +
  geom_ribbon(aes(ymin = ndg$PredLower, ymax = ndg$PredUpper, 
                  fill = HabitatComplexity), alpha = 0.1) +
  geom_hline(yintercept = 0, lty = "dashed", size = 0.4) +
  scale_fill_manual(values = c("#0072B2","#D55E00")) +
  scale_colour_manual(values = c("#0072B2","#D55E00")) +
  theme_bw() + 
  scale_x_continuous(breaks = c(-2,0,2, 4, 6), limits = c(-2, 6)) +
  scale_y_continuous(breaks = c(-100,-50, 0, 50, 100), limits = c(-100, 100)) +
  ylab("Change in national LCBD (%)") +
  xlab("Urban intensification (PC1)") +
  #xlim(c(-1, 5)) +
  #  ylim(c(-60,60)) +  
  theme_light(base_size = 18)+
  theme(legend.position = "none",
        title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size =16),
        #axis.text.x = element_text(size = 12, angle = 45, vjust = 0.5),
        axis.text = element_text(size =18, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        #   axis.ticks = element_line(size = 0.4), 
        axis.line = element_line(size = 0.4)) +
  theme(axis.ticks.length=unit(0.14,"inch"))+
  ggtitle("G")
Figg


# --------------------------Insect National LCBD vs. Urban Intensification
Figh <- ggplot(data = ndh, aes(x = UrbanActivityIndex, y = PredMedian)) + 
  geom_line(aes(col = HabitatComplexity), size = 1) +
  geom_ribbon(aes(ymin = ndh$PredLower, ymax = ndh$PredUpper, 
                  fill = HabitatComplexity), alpha = 0.1) +
  geom_hline(yintercept = 0, lty = "dashed", size = 0.4) +
  scale_fill_manual(values = c("#0072B2","#D55E00")) +
  scale_colour_manual(values = c("#0072B2","#D55E00")) +
  theme_bw() + 
  scale_x_continuous(breaks = c(-2,0,2, 4, 6), limits = c(-2, 6)) +
  scale_y_continuous(breaks = c(-100,-50, 0, 50, 100), limits = c(-100, 100)) +
  ylab("Change in national LCBD (%)") +
  xlab("Urban intensification (PC1)") +
  #xlim(c(-1, 5)) +
  #  ylim(c(-60,60)) +  
  theme_light(base_size = 18)+
  theme(legend.position = "none",
        title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size =16),
        #axis.text.x = element_text(size = 12, angle = 45, vjust = 0.5),
        axis.text = element_text(size =18, colour = "black"),
        axis.ticks = element_line(colour = "black", size = 1.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        #   axis.ticks = element_line(size = 0.4), 
        axis.line = element_line(size = 0.4)) +
  theme(axis.ticks.length=unit(0.14,"inch"))+
  ggtitle("H")
Figh



